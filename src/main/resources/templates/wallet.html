<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Wallet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #232323;
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        header {
            width: 100%;
            height: 60px;
            background-color: #262647;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: fixed;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        header h1 {
            font-size: 20px;
        }

        .balance {
            background: linear-gradient(135deg, #0f9d58, #0d8548);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* Container */
        .container {
            display: flex;
            height: 100vh;
            margin-top: 60px;
        }

        /* Nav izquierda */
        nav {
            width: 80px;
            background-color: #262647;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
        }

        nav a {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            margin: 10px 0;
            background-color: rgba(255,255,255,0.1);
            border-radius: 10px;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 24px;
        }

        nav a:hover, nav a.active {
            background-color: #335099;
        }

        /* Main content */
        .main {
            flex: 1;
            padding: 30px;
            overflow: auto;
        }

        .wallet-title {
            font-size: 28px;
            margin-bottom: 30px;
            color: #0f9d58;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(145deg, #2a2a50, #1e1e40);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #0f9d58;
            margin-bottom: 5px;
        }
        
        /* Lista de criptos */
        .crypto-list {
            background: linear-gradient(145deg, #2a2a50, #1e1e40);
            border-radius: 15px;
            overflow: hidden;
        }

        .crypto-list h3 {
            background-color: #262647;
            padding: 20px;
            font-size: 18px;
            border-bottom: 1px solid #4a4a70;
        }

        .crypto-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: background 0.3s;
        }

        .crypto-item:hover {
            background-color: rgba(255,255,255,0.05);
        }

        .crypto-item:last-child {
            border-bottom: none;
        }

        .crypto-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .crypto-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .crypto-details h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .crypto-details p {
            font-size: 12px;
            color: #ccc;
        }

        .crypto-values {
            text-align: right;
        }

        .crypto-values .price {
            font-size: 16px;
            font-weight: bold;
        }
        .crypto-values .holdings {
            font-size: 14px;
            color: #ccc;
        }

        .options-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 15px;
            transition: all 0.3s;
        }

        .options-btn:hover {
            background: #335099;
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background: linear-gradient(145deg, #2a2a50, #1e1e40);
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 400px;
            max-width: 90%;
            text-align: center;
        }

        .modal h3 {
            color: #ff4444;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .selected-crypto {
            background: rgba(255, 68, 68, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 68, 68, 0.3);
        }

        .crypto-summary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .crypto-summary .icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background-color: #1a1a35;
            border: 1px solid #4a4a70;
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ff4444;
        }

        .total-info {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-cancel {
            background: #4a4a70;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a5a80;
        }

        .btn-sell {
            background: linear-gradient(135deg, #ff4444, #cc3333);
            color: white;
        }

        .btn-sell:hover {
            background: linear-gradient(135deg, #cc3333, #aa2222);
        }

        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #ccc;
        }

        .close:hover {
            color: white;
        }

    </style>
</head>
<body>

<header>
    <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">ðŸ’¼</span>
        <h1>Mi Wallet</h1>
    </div>
    <div class="balance" id="balance-header">$0.00</div>
</header>

<div class="container">
    <nav>
        <a href="wallet.html" class="active">ðŸ’¼</a>
        <a href="principal.html">ðŸ“ˆ</a>
    </nav>

    <div class="main">
        <h2 class="wallet-title">ðŸ’° Mi Cartera</h2>

        <div class="stats">
            <div class="stat-card">
                <h3>Valor Total</h3>
                <div class="value" id="total-value">$0.00</div>
            </div>
            <div class="stat-card">
                <h3>Saldo USD</h3>
                <div class="value" id="usd-balance">$0.00</div>
            </div>
            <div class="stat-card">
                <h3>Valor Cripto</h3>
                <div class="value" id="crypto-value">$0.00</div>
            </div>
        </div>

        <div class="crypto-list">
            <h3>ðŸª™ Mis Criptomonedas</h3>
            <div id="crypto-holdings">
                </div>
        </div>
    </div>
</div>

<div id="sellModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>ðŸ’¸ Vender Cripto</h3>
        <div class="selected-crypto" id="selectedCrypto"></div>
        <div>
            <label>Cantidad a vender:</label>
            <input type="number" id="amount" placeholder="Â¿CuÃ¡nto quieres vender?" oninput="calculate()">
        </div>
        <div class="total-info" id="totalInfo" style="display: none;">
            <div>RecibirÃ¡s: <strong id="totalAmount">$0</strong></div>
        </div>
        <div class="buttons">
            <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
            <button class="btn-sell" onclick="confirmSell()">Vender</button>
        </div>
    </div>
</div>

<script>
    let API_BASE_URL = 'http://157.245.164.138:8080';
    let selectedCrypto = null;

    document.addEventListener("DOMContentLoaded", function() {
        loadWalletData();
    });

    function log(message, type = 'info') {
        alert(message);
    }

    async function makeRequest(url, options = {}) {
        const token = localStorage.getItem("authToken");
        if (token) {
            options.headers = {
                ...options.headers,
                'Authorization': 'Bearer ' + token
            };
        }
        try {
            const response = await fetch(url, { mode: 'cors', ...options });
            const responseData = await response.json();
            return { data: responseData, status: response.status, ok: response.ok };
        } catch (e) {
            return { error: e.message, status: 0 };
        }
    }
    
    async function loadWalletData() {
        const result = await makeRequest(`${API_BASE_URL}/api/portafolio/resumen`);

        if (result.ok) {
            const data = result.data;
            document.getElementById('balance-header').textContent = `$${data.valorTotalPortafolio.toFixed(2)}`;
            document.getElementById('total-value').textContent = `$${data.valorTotalPortafolio.toFixed(2)}`;
            document.getElementById('usd-balance').textContent = `$${data.saldoUsd.toFixed(2)}`;
            document.getElementById('crypto-value').textContent = `$${data.valorTotalCripto.toFixed(2)}`;
            
            const holdingsContainer = document.getElementById('crypto-holdings');
            holdingsContainer.innerHTML = '';
            
            data.criptoHoldings.forEach(holding => {
                const item = document.createElement('div');
                item.className = 'crypto-item';
                item.innerHTML = `
                    <div class="crypto-icon" style="background-color: #f7931a;">${holding.simbolo.charAt(0)}</div>
                    <div class="crypto-info">
                        <div class="crypto-details">
                            <h4>${holding.nombre}</h4>
                            <p>${holding.simbolo} â€¢ ${holding.cantidad} disponibles</p>
                        </div>
                        <div class="crypto-values">
                            <div class="price">$${holding.precioActual.toFixed(4)}</div>
                            <div class="holdings">$${holding.valorTotal.toFixed(2)}</div>
                        </div>
                    </div>
                    <button class="options-btn" onclick='openSell(${JSON.stringify(holding)})'>Vender</button>
                `;
                holdingsContainer.appendChild(item);
            });
        }
    }

    function openSell(holding) {
        selectedCrypto = holding;
        document.getElementById('selectedCrypto').innerHTML = `
            <div class="crypto-summary">
                <div class="icon" style="background-color: #f7931a;">${selectedCrypto.simbolo.charAt(0)}</div>
                <div>
                    <h4>${selectedCrypto.nombre}</h4>
                    <p>${selectedCrypto.cantidad} disponibles</p>
                    <p style="color: #ff4444;">$${selectedCrypto.precioActual.toFixed(4)} cada una</p>
                </div>
            </div>
        `;

        document.getElementById('sellModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('sellModal').style.display = 'none';
        selectedCrypto = null;
        document.getElementById('amount').value = '';
        document.getElementById('totalInfo').style.display = 'none';
    }

    function calculate() {
        if (!selectedCrypto) return;

        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const total = amount * selectedCrypto.precioActual;

        if (amount > 0) {
            document.getElementById('totalAmount').textContent = '$' + total.toFixed(2);
            document.getElementById('totalInfo').style.display = 'block';
        } else {
            document.getElementById('totalInfo').style.display = 'none';
        }
    }
    
    async function confirmSell() {
        if (!selectedCrypto) return;

        const amount = parseFloat(document.getElementById('amount').value);
        if (!amount || amount <= 0) {
            log('Ingresa una cantidad vÃ¡lida', 'error');
            return;
        }
        if (amount > selectedCrypto.cantidad) {
            log('No tienes suficiente saldo para vender', 'error');
            return;
        }

        const requestBody = {
            symboloCripto: selectedCrypto.simbolo,
            tipoOperacion: 'VENTA',
            cantidad: amount
        };

        const result = await makeRequest(`${API_BASE_URL}/api/trading/execute`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (result.ok && result.data.exitoso) {
            log('Â¡Venta exitosa! ðŸŽ‰', 'success');
            closeModal();
            loadWalletData(); // Recargar datos
        } else {
            log('Error en la venta: ' + (result.data?.mensaje || result.error), 'error');
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById('sellModal');
        if (event.target === modal) {
            closeModal();
        }
    }
</script>

</body>
</html>

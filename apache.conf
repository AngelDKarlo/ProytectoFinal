# apache-fixed.conf - Configuración Apache corregida

# Configuración básica del servidor
ServerRoot "/usr/local/apache2"
Listen 80
Listen 443 ssl

# Módulos necesarios
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule headers_module modules/mod_headers.so

# Configuración básica
ServerName localhost
DirectoryIndex index.html

# Configuración de tipos MIME
TypesConfig conf/mime.types

# Configuración de directorios
DocumentRoot "/usr/local/apache2/htdocs"

<Directory "/usr/local/apache2/htdocs">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# Configuración de logs
ErrorLog /usr/local/apache2/logs/error.log
CustomLog /usr/local/apache2/logs/access.log combined

# CONFIGURACIÓN DEL PROXY PARA LA API
ProxyPreserveHost On
ProxyRequests Off

# Headers CORS
Header always set Access-Control-Allow-Origin "*"
Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"

# Proxy para la API Spring Boot
ProxyPass /api/ http://app:8080/api/
ProxyPassReverse /api/ http://app:8080/api/

# Manejar OPTIONS requests para CORS
RewriteEngine On
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# Página de inicio simple
<Location "/">
    <RequireAll>
        Require all granted
    </RequireAll>
</Location>

# Status page para monitoreo
<Location "/status">
    SetHandler server-status
    Require all granted
</Location>

# Configuración SSL (si existe el certificado)
<IfModule mod_ssl.c>
    <VirtualHost *:443>
        ServerName localhost
        
        SSLEngine on
        SSLCertificateFile /usr/local/apache2/conf/ssl/cert.pem
        SSLCertificateKeyFile /usr/local/apache2/conf/ssl/key.pem
        
        # Proxy SSL
        ProxyPass /api/ http://app:8080/api/
        ProxyPassReverse /api/ http://app:8080/api/
        
        # Headers para SSL
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    </VirtualHost>
</IfModule>

# Configuración de seguridad
ServerTokens Prod
ServerSignature Off

# Optimizaciones
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

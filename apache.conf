# apache.conf - Configuración corregida para Apache como Reverse Proxy

ServerRoot "/usr/local/apache2"
Listen 80

# Cargar módulos necesarios para el reverse proxy
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule headers_module modules/mod_headers.so
LoadModule rewrite_module modules/mod_rewrite.so

# Configuración de logs
ErrorLog "logs/error_log"
CustomLog "logs/access_log" common

<VirtualHost *:80>
    ServerName 157.245.164.138

    # Configuración de seguridad
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Configuración de CORS
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"

    # Manejo de preflight requests (OPTIONS)
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=204,L]

    # Configuración del Proxy - CORREGIDO
    ProxyPreserveHost On
    ProxyRequests Off

    # Proxy directo al contenedor Spring Boot
    ProxyPass /api/ http://app:8080/api/
    ProxyPassReverse /api/ http://app:8080/api/

    # Configuraciones de timeout
    ProxyTimeout 300
    ProxyBadHeader Ignore

    # Para requests directos sin /api (opcional)
    ProxyPass /health http://app:8080/actuator/health
    ProxyPassReverse /health http://app:8080/actuator/health

</VirtualHost>